name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_VERSION: '18.x'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          src/ui/package-lock.json
          src/bridge/package-lock.json

    - name: Ensure package-lock.json exists
      shell: pwsh
      run: |
        # Create package-lock.json if missing
        if (-not (Test-Path "package-lock.json")) {
          Write-Host "Creating package-lock.json..."
          npm init -y
          npm install --package-lock-only
        }
        
        # Create for src/ui
        if (-not (Test-Path "src/ui/package-lock.json")) {
          Write-Host "Creating src/ui/package-lock.json..."
          Push-Location "src/ui"
          npm init -y
          npm install --package-lock-only
          Pop-Location
        }
        
        # Create for src/bridge  
        if (-not (Test-Path "src/bridge/package-lock.json")) {
          Write-Host "Creating src/bridge/package-lock.json..."
          Push-Location "src/bridge"
          npm init -y
          npm install --package-lock-only
          Pop-Location
        }

    - name: Install root dependencies
      run: npm ci --no-audit --prefer-offline

    - name: Install UI dependencies
      run: |
        cd src/ui
        npm ci --no-audit --prefer-offline

    - name: Install bridge dependencies
      run: |
        cd src/bridge
        npm ci --no-audit --prefer-offline

    - name: Verify icon.ico exists
      shell: pwsh
      run: |
        $iconPath = "src/ui/assets/icon.ico"
        if (Test-Path $iconPath) {
          Write-Host "‚úÖ Icon found: $iconPath"
          $fileInfo = Get-Item $iconPath
          Write-Host "Icon size: $($fileInfo.Length) bytes"
        } else {
          Write-Warning "‚ö†Ô∏è Icon not found: $iconPath"
          Write-Host "Creating placeholder icon for build..."
          # Create minimal ICO file as fallback
          $icoData = [byte[]]@(
            0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x20, 0x20,
            0x00, 0x00, 0x01, 0x00, 0x20, 0x00, 0xA8, 0x10,
            0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00,
            0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x40, 0x00,
            0x00, 0x00, 0x01, 0x00, 0x20, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00
          )
          New-Item -Path $iconPath -ItemType File -Force | Out-Null
          [System.IO.File]::WriteAllBytes($iconPath, $icoData)
          Write-Host "Placeholder icon created"
        }

    - name: Build Windows executable
      run: npm run build:windows
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CI: true
        ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true

    - name: List build artifacts
      shell: pwsh
      run: |
        Write-Host "Build artifacts in dist/:"
        if (Test-Path "dist") {
          Get-ChildItem -Path "dist" -Recurse -File | ForEach-Object {
            Write-Host "  $($_.FullName.Substring($pwd.Path.Length + 1)) - $($_.Length) bytes"
          }
        } else {
          Write-Error "dist directory not found!"
        }

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: aureate-launcher-windows-${{ github.sha }}
        path: |
          dist/*.exe
          dist/*.msi
          dist/*.nsis.exe
          dist/*.zip
        if-no-files-found: error
        retention-days: 90

  create-release:
    needs: build-windows
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: aureate-launcher-windows-${{ github.sha }}
        path: artifacts/

    - name: Display artifact info
      shell: pwsh
      run: |
        Write-Host "Artifacts to release:"
        Get-ChildItem -Path "artifacts" -Recurse -File | ForEach-Object {
          Write-Host "  $($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
        }

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          # üéÆ Aureate Minecraft Launcher
          
          ## üì¶ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ
          - –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Minecraft —Å –º–æ–¥–∞–º–∏
          - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–±–æ—Ä–æ–∫ Draconica –∏ Skydustry
          - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Java
          - –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          
          ## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          1. –°–∫–∞—á–∞–π—Ç–µ `Aureate-Launcher-Setup-*.exe`
          2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
          3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
          
          ## üìÅ Portable –≤–µ—Ä—Å–∏—è
          –î–ª—è –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `Aureate-Launcher-Portable-*.zip`
          
          ## üõ† –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
          - **–û–°:** Windows 10/11 (64-bit)
          - **–ü–∞–º—è—Ç—å:** 4 GB –º–∏–Ω–∏–º—É–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 8 GB)
          - **–ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ:** 10 GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
          - **–ò–Ω—Ç–µ—Ä–Ω–µ—Ç:** —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
          
          ## üîß –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–±–æ—Ä–∫–∏
          | –°–±–æ—Ä–∫–∞ | –í–µ—Ä—Å–∏—è Minecraft | –ú–æ–¥–ª–æ–∞–¥–µ—Ä |
          |--------|-----------------|-----------|
          | Draconica | 1.18.2 | Forge |
          | Skydustry | 1.20.1 | Forge |
          
          ## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞
          –ü—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –≤ [Issues](https://github.com/${{ github.repository }}/issues)
          
          ---
          *–°–±–æ—Ä–∫–∞: ${{ github.sha }}*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}